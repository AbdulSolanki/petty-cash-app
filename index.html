<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Construction Finance System</title>
<script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<style>
body { margin:0; font-family: Arial; display:flex; height:100vh; }
#sidebar { width:220px; background:#1f2937; color:white; padding:20px; display:flex; flex-direction:column; }
#sidebar h2 { margin-top:0; }
.sidebar-item { padding:10px; cursor:pointer; border-radius:6px; margin-bottom:5px; }
.sidebar-item:hover { background:#374151; }
.sidebar-item.hidden { display:none; }
#main { flex:1; background:#f4f6f8; padding:20px; overflow:auto; }
.card { background:white; padding:15px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); margin-bottom:20px; }
input, select { width:100%; padding:8px; margin:5px 0; }
button { padding:8px; background:#2563eb; color:white; border:none; cursor:pointer; border-radius:4px; }
button:hover { background:#1d4ed8; }
.row { display:flex; gap:10px; margin-bottom:10px; }
.row input, .row select { flex:1; }
#loginPage { width:100%; display:flex; justify-content:center; align-items:center; }
#appLayout { display:none; width:100%; }
.admin-section { margin-bottom:15px; }
.admin-section h3 { cursor:pointer; }
.hidden-section { display:none; }
</style>
</head>

<body>

<div id="loginPage">
  <div class="card" style="width:350px;">
    <h2>Login</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button id="loginBtn">Login</button>
  </div>
</div>

<div id="appLayout">
  <div id="sidebar">
    <h2>Finance</h2>
    <div id="navDashboard" class="sidebar-item">Dashboard</div>
    <div id="navExpense" class="sidebar-item hidden">Petty Expense</div>
    <div id="navCredit" class="sidebar-item hidden">Petty Credit</div>
    <div id="navAdmin" class="sidebar-item hidden">Admin Panel</div>
    <div style="margin-top:auto;">
      <div id="navLogout" class="sidebar-item">Logout</div>
    </div>
  </div>
  <div id="main"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function(){

const supabaseClient = supabase.createClient(
  "https://nwaewefiihkxjbkfmxrj.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im53YWV3ZWZpaWhreGpia2ZteHJqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5OTIwNTUsImV4cCI6MjA4NjU2ODA1NX0.ZfgHbHu9pYFemHserU0o4DJZ3P71UxmbZGuFOuz3ams"
);

const PROJECT_REF = "nwaewefiihkxjbkfmxrj";

let currentUser = null;
let userPermissions = [];
let cachedCategories = [];

const loginPage = document.getElementById("loginPage");
const appLayout = document.getElementById("appLayout");
const main = document.getElementById("main");

document.getElementById("loginBtn").addEventListener("click", login);
document.getElementById("navLogout").addEventListener("click", logout);
document.getElementById("navDashboard").addEventListener("click", renderDashboard);
document.getElementById("navExpense").addEventListener("click", renderExpense);
document.getElementById("navCredit").addEventListener("click", renderCredit);
document.getElementById("navAdmin").addEventListener("click", renderAdmin);

async function login(){
  const email=document.getElementById("email").value;
  const password=document.getElementById("password").value;

  const {data,error}=await supabaseClient.auth.signInWithPassword({email,password});
  if(error){alert(error.message);return;}

  currentUser=data.user;
  loginPage.style.display="none";
  appLayout.style.display="flex";

  await loadPermissions();
  renderDashboard();
}

async function loadPermissions(){
  const { data, error } = await supabaseClient.rpc('get_user_permissions');

  if(error){
    alert("Permission load error: "+error.message);
    return;
  }

  userPermissions = data.map(p=>p.permission_name);

  if(userPermissions.includes("create_expense"))
    document.getElementById("navExpense").classList.remove("hidden");

  if(userPermissions.includes("create_credit"))
    document.getElementById("navCredit").classList.remove("hidden");

  if(userPermissions.includes("manage_roles"))
    document.getElementById("navAdmin").classList.remove("hidden");
}

async function renderDashboard(){
  const {data:credits}=await supabaseClient.from("credits").select("amount");
  const {data:expenses}=await supabaseClient.from("expenses").select("amount");

  const totalCredit=(credits||[]).reduce((s,c)=>s+Number(c.amount),0);
  const totalExpense=(expenses||[]).reduce((s,e)=>s+Number(e.amount),0);

  main.innerHTML=`
    <div class="card">
      <h2>Dashboard</h2>
      <p>Total Credit: ${totalCredit}</p>
      <p>Total Expense: ${totalExpense}</p>
      <p>Balance: ${totalCredit-totalExpense}</p>
    </div>
  `;
}

async function renderExpense(){
  const {data:sites}=await supabaseClient.from("sites").select("*");
  const {data:categories}=await supabaseClient.from("categories").select("*");
  cachedCategories=categories||[];

  main.innerHTML=`
    <div class="card">
      <h2>Petty Cash Expense</h2>
      <select id="expenseSite">
        ${(sites||[]).map(s=>`<option value="${s.id}">${s.name}</option>`).join("")}
      </select>
      <div id="expenseContainer"></div>
      <button id="addRowBtn">+ Add Expense</button>
      <button id="saveExpenseBtn">Save</button>
    </div>
  `;

  document.getElementById("addRowBtn").addEventListener("click", addExpenseRow);
  document.getElementById("saveExpenseBtn").addEventListener("click", saveExpense);
  addExpenseRow();
}

function addExpenseRow(){
  const div=document.createElement("div");
  div.className="row";
  div.innerHTML=`
    <input type="number" class="amount" placeholder="Amount">
    <select class="category">
      ${cachedCategories.map(c=>`<option value="${c.id}">${c.name}</option>`).join("")}
    </select>
    <input type="text" class="desc" placeholder="Description">
  `;
  document.getElementById("expenseContainer").appendChild(div);
}

async function saveExpense(){
  const rows=document.querySelectorAll(".row");
  const site_id=document.getElementById("expenseSite").value;
  const inserts=[];
  rows.forEach(r=>{
    const amount=r.querySelector(".amount").value;
    const category_id=r.querySelector(".category").value;
    const description=r.querySelector(".desc").value;
    if(amount){ inserts.push({site_id,user_id:currentUser.id,category_id,amount,description}); }
  });

  if(inserts.length===0){ alert("No entries"); return; }

  const {error}=await supabaseClient.from("expenses").insert(inserts);
  if(error){ alert(error.message); return; }

  alert("Saved");
  renderDashboard();
}

async function renderCredit(){
  const {data:sites}=await supabaseClient.from("sites").select("*");

  main.innerHTML=`
    <div class="card">
      <h2>Petty Cash Credit</h2>
      <select id="creditSite">
        ${(sites||[]).map(s=>`<option value="${s.id}">${s.name}</option>`).join("")}
      </select>
      <input type="number" id="creditAmount" placeholder="Amount">
      <button id="saveCreditBtn">Save</button>
    </div>
  `;

  document.getElementById("saveCreditBtn").addEventListener("click", async ()=>{
    const site_id=document.getElementById("creditSite").value;
    const amount=document.getElementById("creditAmount").value;
    const {error}=await supabaseClient.from("credits").insert([{site_id,amount,created_by:currentUser.id}]);
    if(error){alert(error.message);return;}
    alert("Credit added");
    renderDashboard();
  });
}

async function renderAdmin(){
  main.innerHTML=`
    <div class="card">
      <h2>Admin Panel</h2>

      <div class="admin-section">
        <h3 onclick="toggleSection('userSection')">▸ Users</h3>
        <div id="userSection" class="hidden-section">
          <input type="email" id="newUserEmail" placeholder="Email">
          <input type="password" id="newUserPassword" placeholder="Password">
          <button onclick="createUser()">Create User</button>
        </div>
      </div>

      <div class="admin-section">
        <h3 onclick="toggleSection('siteSection')">▸ Sites</h3>
        <div id="siteSection" class="hidden-section">
          <input type="text" id="newSiteName" placeholder="Site Name">
          <button onclick="createSite()">Create Site</button>
        </div>
      </div>

    </div>
  `;
}

window.toggleSection=function(id){
  const el=document.getElementById(id);
  el.style.display = el.style.display==="block"?"none":"block";
}

window.createUser=async function(){
  const email=document.getElementById("newUserEmail").value;
  const password=document.getElementById("newUserPassword").value;

  const {data}=await supabaseClient.auth.getSession();
  const token=data.session.access_token;

  const response=await fetch(
    `https://${PROJECT_REF}.functions.supabase.co/create-user`,
    {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":"Bearer "+token
      },
      body:JSON.stringify({email,password})
    }
  );

  const text=await response.text();
  if(!response.ok){alert("Error: "+text);return;}
  alert(text);
}

window.createSite=async function(){
  const name=document.getElementById("newSiteName").value;
  const {error}=await supabaseClient.from("sites").insert([{name}]);
  if(error){alert(error.message);return;}
  alert("Site created");
}

async function logout(){
  await supabaseClient.auth.signOut();
  location.reload();
}

});
</script>
</body>
</html>
